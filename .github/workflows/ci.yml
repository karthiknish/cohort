name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    env:
      NEXT_TELEMETRY_DISABLED: "1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Seed CI environment
        run: |
          cat <<'EOF' > .env.local
          NEXT_PUBLIC_APP_URL=http://localhost:3000
          NEXT_PUBLIC_RUNTIME_ENV=ci
          NEXT_PUBLIC_FIREBASE_API_KEY=ci-firebase-api-key
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=ci-firebase.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=ci-firebase
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=ci-firebase.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=1234567890
          NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abcdef123456
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-CITEST1234
          FIREBASE_ADMIN_PROJECT_ID=ci-firebase
          FIREBASE_ADMIN_CLIENT_EMAIL=firebase-admin@ci.local
          FIREBASE_ADMIN_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nFAKEKEY\n-----END PRIVATE KEY-----"
          FIREBASE_ADMIN_PRIVATE_KEY_B64=
          FIREBASE_ADMIN_SERVICE_ACCOUNT_KEY=
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_ci
          STRIPE_PUBLISHABLE_KEY=pk_test_ci
          STRIPE_SECRET_KEY=sk_test_ci
          STRIPE_WEBHOOK_SECRET=whsec_ci
          STRIPE_PRICE_STARTER_MONTHLY=price_starter_ci
          STRIPE_PRICE_GROWTH_MONTHLY=price_growth_ci
          STRIPE_PRICE_SCALE_MONTHLY=price_scale_ci
          NEXT_PUBLIC_FEATURE_BREADCRUMBS=false
          NEXT_PUBLIC_FEATURE_BIDIRECTIONAL_NAV=false
          NEXT_PUBLIC_FEATURE_NAVIGATION_PERSISTENCE=false
          NEXT_PUBLIC_FEATURE_ACTIVITY_WIDGET=false
          METRIC_SECRET=ci-metric-secret
          JWT_SECRET=ci-jwt-secret
          NEXTAUTH_SECRET=ci-nextauth-secret
          GEMINI_API_KEY=ci-gemini-key
          GAMMA_API_KEY=ci-gamma-key
          META_APP_ID=ci-meta-app
          META_APP_SECRET=ci-meta-secret
          META_BUSINESS_CONFIG_ID=ci-meta-config
          META_OAUTH_REDIRECT_URI=https://ci.example.com/meta/oauth
          META_APP_SCOPES=business_management
          GOOGLE_ADS_DEVELOPER_TOKEN=ci-google-ads-dev-token
          GOOGLE_ADS_CLIENT_ID=ci-google-client
          GOOGLE_ADS_CLIENT_SECRET=ci-google-secret
          TIKTOK_CLIENT_KEY=ci-tiktok-key
          TIKTOK_CLIENT_SECRET=ci-tiktok-secret
          TIKTOK_OAUTH_REDIRECT_URI=https://ci.example.com/tiktok/oauth
          TIKTOK_OAUTH_SCOPES=tiktok.scopes.basic
          INTEGRATIONS_CRON_SECRET=ci-cron-secret
          SCHEDULER_ALERT_WEBHOOK_URL=https://example.com/hooks/scheduler
          SCHEDULER_ALERT_FAILURE_THRESHOLD=3
          ADMIN_EMAILS=ci-admin@example.com
          CONTACT_EMAIL_WEBHOOK_URL=https://example.com/hooks/email
          CONTACT_SLACK_WEBHOOK_URL=https://hooks.slack.com/services/T000/B000/XXXX
          WHATSAPP_BUSINESS_API_VERSION=v18.0
          WHATSAPP_BUSINESS_ACCESS_TOKEN=ci-whatsapp-token
          WHATSAPP_BUSINESS_PHONE_NUMBER_ID=1234567890
          NEXT_PUBLIC_APP_VERSION=ci
          EOF

      - name: Run ESLint
        run: npm run lint

      - name: Run Vitest
        run: npm run test -- --runInBand

      - name: Build Next.js app
        run: npm run build
